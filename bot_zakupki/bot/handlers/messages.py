from typing import List

from bot_zakupki.bot.handlers import commands
from bot_zakupki.common import dates
from bot_zakupki.common import models

CMD_START_MSG = (
    f"–ü—Ä–∏–≤–µ—Ç) –ú—ã –ø–æ–º–æ–∂–µ–º —Ç–µ–±–µ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∑–∞–∫—É–ø–∫–∏ üòé\n"
    f"\n"
    f"–î–ª—è —ç—Ç–æ–≥–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞. "
    f"–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ "
    f"–∫–æ–º–∞–Ω–¥—ã /{commands.ADD_NEW_QUERY}\n "
    f"\n"
    f"–£ —Ç–µ–±—è –±—É–¥–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ 4-—Ö –Ω–µ–¥–µ–ª—å."
    f"–í —Ç–µ—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, –∫–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å, 8 —É—Ç—Ä–∞, "
    f"—Ç–µ–±–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–ª—è —Ç–µ–±—è –∑–∞–∫—É–ø–∫–∏.\n"
)

# ========== SEARCH_QUERY_HANDLERS ==========
NEW_QUERY_MSG = (
    "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—ã —Å–º–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, "
    "—Ç–∞–∫ —á—Ç–æ –Ω–µ –±–æ–π—Å—è –æ—à–∏–±–∏—Ç—å—Å—è üôÇ\n"
    "\n"
    "–î–ª—è –Ω–∞—á–∞–ª–∞, –≤–≤–µ–¥–∏ <b>–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ</b>, "
    "–ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å —Ç–µ–±–µ –∑–∞–∫—É–ø–∫–∏.\n"
    "–°–ª–æ–≤–∞ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ –∏ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ, "
    "–∏–Ω–æ–≥–¥–∞ –¥–∞–∂–µ –±–µ–∑ –æ–∫–æ–Ω—á–∞–Ω–∏–π.\n"
    "\n"
    "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
    "- <b>—Ç–µ–ª–µ—Ñ–æ–Ω</b>, –∞ –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã\n"
    "- <b>—à–æ–∫–æ–ª–∞–¥ —Ç–æ—Ä—Ç</b>, –∞ –Ω–µ —à–æ–∫–æ–ª–∞–¥–Ω—ã–µ —Ç–æ—Ä—Ç—ã\n"
    "\n"
    "–ò—Ç–∞–∫, –≤–≤–µ–¥–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ:\n"
)

SELECT_LOCATION = "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: "

SELECT_LOCATION_INVALID = (
    "–ù–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω —Ä–µ–≥–∏–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ"
)

SET_MINIMUM_PRICE = "–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö:"

SET_MINIMUM_PRICE_INVALID = (
    "–ù–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞. "
    "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º, –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.\n"
    "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
)

SET_MAXIMUM_PRICE = "–ò –Ω–∞–∫–æ–Ω–µ—Ü –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö:"

SET_MAX_PRICE_INVALID = (
    "–ù–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞. "
    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º, –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.\n"
    "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
)

SET_MAX_PRICE_LESS_THAN_MIN = (
    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π. –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –ø–æ–±–æ–ª—å—à–µ üôÇ"
)

CANNOT_ADD_MORE_QUERY_IN_TRIAL_PERIOD = (
    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞–≤–Ω–æ 3."
)

TOO_MANY_NOT_ACTIVE_QUERIES = (
    "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. "
    "–ò–∑–º–µ–Ω–∏—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã."
)

NO_QUERIES = "–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"

SEARCH_STRING = "–ö–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞"
REGION = "–†–µ–≥–∏–æ–Ω"

WHICH_QUERY_CHANGE = "–ö–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"

UPDATED_QUERY = "–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞"


# —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ö–ê —Å –∑–∞–¥–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
def query_message_formation(
        search_string: str, location: str, min_price: int, max_price: int, with_n: bool = True
) -> str:
    delimiter = ""
    if with_n:
        delimiter = "\n"
    answer = (
        f"üîç {SEARCH_STRING}: <b>{search_string}</b>\n"
        f"{delimiter}"
        f"üåè {REGION}: {location}\n"
        f"{delimiter}"
        f"üí∞ –¶–µ–Ω–∞: –æ—Ç {min_price} –¥–æ {max_price} —Ä—É–±–ª–µ–π"
    )

    return answer


def changed_query_message_formation(
        search_string: str,
        location: str,
        min_price: int,
        max_price: int,
        query_number: str,
) -> str:
    answer = (
        f"{UPDATED_QUERY} <b>{query_number}.\n</b>"
        f"\n"
    )
    query = query_message_formation(search_string, location, min_price, max_price, False)

    return answer + query


def all_queries_messages_formation(queries: List[models.SearchQuery]) -> str:
    answer = ""
    if not queries:
        answer = NO_QUERIES

    for i, query in enumerate(queries):
        tmp = (
            f"<b>{i + 1}</b>. üîç {SEARCH_STRING}: {query.search_string}\n"
            f"    üåè {REGION}: {query.location}\n"
            f"    üí∞ –¶–µ–Ω–∞: –æ—Ç {query.min_price} –¥–æ {query.max_price} —Ä—É–±–ª–µ–π\n"
        )

        subscription_msg = ""
        subscription_last_day = query.subscription_last_day
        now = dates.get_current_time_for_db()
        if subscription_last_day is not None and now < subscription_last_day:
            subscription_msg = (
                f"    üóìÔ∏è –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏: "
                f"{dates.format_date(query.subscription_last_day)}\n"
            )
        else:
            subscription_msg = f"    üóìÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞"
        tmp += subscription_msg
        tmp += "\n"

        answer += tmp

    return answer
