from typing import List

from bot_zakupki.bot.handlers import commands
from bot_zakupki.common import consts
from bot_zakupki.common import dates
from bot_zakupki.common import models
from bot_zakupki.common import utils

CMD_START_MSG = (
    f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ) –ú—ã –ø–æ–º–æ–∂–µ–º –≤–∞–º –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–ª—è –≤–∞—Å –∑–∞–∫—É–ø–∫–∏ üòé\n"
    f"\n"
    f"–ö–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å, –≤ 8 —É—Ç—Ä–∞, –º—ã –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å–ø–∏—Å–æ–∫"
    f" –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–ª—è –≤–∞—Å –∑–∞–∫—É–ø–æ–∫. "
    f"\n"
    f"–î–ª—è —ç—Ç–æ–≥–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"
    f" –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏ "
    f"–∫–æ–º–∞–Ω–¥—ã /{commands.ADD_NEW_QUERY}\n"
    f"\n"
    f"–£ –≤–∞—Å –±—É–¥–µ—Ç –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-—Ö –Ω–µ–¥–µ–ª—å. "
    f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞–≤–Ω–æ 3.\n"
    f"\n"
    f"–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã /{commands.HELP}\n "
)

CMD_HELP_MSG = (
    f"<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n"
    f"–ö–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å, –≤ 8 —É—Ç—Ä–∞, –º—ã –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö"
    f" –¥–ª—è –≤–∞—Å –∑–∞–∫—É–ø–æ–∫.\n"
    f"\n"
    f"<b>–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</b>\n"
    f"–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª–∏—Ç—Å—è 2 –Ω–µ–¥–µ–ª–∏. "
    f"–í –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–≤–Ω–æ 3. "
    f"–¢–æ –µ—Å—Ç—å, –∫–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å –º—ã –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∑–∞–∫—É–ø–∫–∏"
    f" –ø–æ 3-–º —Ä–∞–∑–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º.\n"
    f"\n"
    f"<b>–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ </b>\n"
    f"/{commands.ADD_NEW_QUERY} - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n"
    f"/{commands.SHOW_ALL_MY_QUERIES} - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º—è –≤–∞—à–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏"
    f" –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n"
    f"/{commands.CHANGE_QUERY} - –ø—Ä–∏ –ø–æ–º–æ—â–∏ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å"
    f" –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –∑–∞–ø—Ä–æ—Å\n"
    f"/{commands.HELP} - –ø–æ–∫–∞–∂–µ—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ —Ä–∞–∑ üòä\n"
    f"\n"
    f"<b>–ö–∞–∫ —Å –Ω–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è?</b>\n "
    f"–ü–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –Ω–∞–º –Ω–∞ –ø–æ—á—Ç—É zakupki_info@gmail.com"
)

CMD_HELP_SUBSCRIPTION_MSG = ""

# ========== SEARCH_QUERY_HANDLERS ==========


class CannotAddMoreQueries:
    TRIAL_PERIOD_LIMIT = (
        f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"
        f" –≤ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞–≤–Ω–æ {consts.MAX_QUERIES_IN_TRIAL_PERIOD}."
    )
    COMMON_PERIOD_LIMIT = (
        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –ø–æ–∫–∞ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ,"
        f" —á–µ–º {consts.MAX_QUERIES_IN_COMMON_PERIOD} –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤."
    )


NEW_QUERY_MSG = (
    "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—ã —Å–º–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, "
    "—Ç–∞–∫ —á—Ç–æ –Ω–µ –±–æ–π—Å—è –æ—à–∏–±–∏—Ç—å—Å—è üôÇ\n"
    "\n"
    "–î–ª—è –Ω–∞—á–∞–ª–∞, –≤–≤–µ–¥–∏ <b>–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ</b>, "
    "–ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –º—ã –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å —Ç–µ–±–µ –∑–∞–∫—É–ø–∫–∏.\n"
    "–°–ª–æ–≤–∞ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ –∏ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–º –ø–∞–¥–µ–∂–µ, "
    "–∏–Ω–æ–≥–¥–∞ –¥–∞–∂–µ –±–µ–∑ –æ–∫–æ–Ω—á–∞–Ω–∏–π.\n"
    "\n"
    "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
    "- <b>—Ç–µ–ª–µ—Ñ–æ–Ω</b>, –∞ –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã\n"
    "- <b>—à–æ–∫–æ–ª–∞–¥ —Ç–æ—Ä—Ç</b>, –∞ –Ω–µ —à–æ–∫–æ–ª–∞–¥–Ω—ã–µ —Ç–æ—Ä—Ç—ã\n"
    "\n"
    "–ò—Ç–∞–∫, –≤–≤–µ–¥–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Å–ª–æ–≤–æ—Å–æ—á–µ—Ç–∞–Ω–∏–µ:\n"
)

# ===LOCATION===
SELECT_LOCATION = "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: "
SELECT_LOCATION_INVALID = (
    "–ù–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω —Ä–µ–≥–∏–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ"
)

# ===PRICE===
SET_MIN_PRICE = "–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö:"
SET_MIN_PRICE_INVALID = (
    "–ù–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞. "
    "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º, –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.\n"
    "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
)

SET_MAX_PRICE = "–ò –Ω–∞–∫–æ–Ω–µ—Ü –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö:"
SET_MAX_PRICE_NOT_A_NUMBER = (
    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.\n" "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
)
SET_MAX_PRICE_LESS_THAN_MIN = (
    "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π. –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –ø–æ–±–æ–ª—å—à–µ üôÇ"
)


NO_QUERIES = "–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"

SEARCH_STRING = "–ö–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞"
REGION = "–†–µ–≥–∏–æ–Ω"

WHICH_QUERY_CHANGE = "–ö–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"
UPDATED_QUERY = "–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞"
THERE_IS_NO_QUERIES = (
    f"–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ üôÇ. \n"
    f"–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫—É–ø–æ–∫ –º–æ–∂–Ω–æ "
    f"–∫–æ–º–∞–Ω–¥–æ–π /{commands.ADD_NEW_QUERY}\n"
)


# —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ö–ê —Å –∑–∞–¥–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
def query_message_formation(
    search_string: str,
    location: str,
    min_price: int,
    max_price: int,
    with_n: bool = True,
) -> str:
    delimiter = ""
    if with_n:
        delimiter = "\n"

    min_price_str = utils.format_price_for_message(min_price)
    max_price_str = utils.format_price_for_message(max_price)

    answer = (
        f"üîç {SEARCH_STRING}: <b>{search_string}</b>\n"
        f"{delimiter}"
        f"üåè {REGION}: {location}\n"
        f"{delimiter}"
        f"üí∞ –¶–µ–Ω–∞: –æ—Ç {min_price_str} –¥–æ {max_price_str} —Ä—É–±–ª–µ–π"
    )

    return answer


def changed_query_message_formation(
    search_string: str,
    location: str,
    min_price: int,
    max_price: int,
    query_number: str,
) -> str:
    answer = f"{UPDATED_QUERY} <b>{query_number}.\n</b>" f"\n"
    query = query_message_formation(
        search_string, location, min_price, max_price, False
    )

    return answer + query


def all_queries_messages_formation(queries: List[models.SearchQuery]) -> str:
    answer = ""
    if not queries:
        answer = NO_QUERIES

    for i, query in enumerate(queries):
        min_price = utils.format_price_for_message(query.min_price)
        max_price = utils.format_price_for_message(query.max_price)
        tmp = (
            f"<b>{i + 1}</b>. üîç {SEARCH_STRING}: {query.search_string}\n"
            f"    üåè {REGION}: {query.location}\n"
            f"    üí∞ –¶–µ–Ω–∞: –æ—Ç {min_price} –¥–æ {max_price} —Ä—É–±–ª–µ–π\n"
        )

        subscription_msg = ""
        subscription_last_day = query.subscription_last_day
        now = dates.get_current_time_for_db()
        if subscription_last_day is not None and now < subscription_last_day:
            subscription_msg = (
                f"    üóìÔ∏è –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏: "
                f"{dates.format_date(query.subscription_last_day)}\n"
            )
        else:
            subscription_msg = "    üóìÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞\n"

        tmp += subscription_msg
        tmp += "\n"

        answer += tmp

    return answer


def command_log_formation(command: str, user_id: int):
    return f'Command "/{command}" was used by user {user_id}'
